(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-chat-chat-chat"],{1524:function(t,e,i){"use strict";var n;i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){return n}));var a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-uni-view",{staticClass:"rounded mr-2 px-2 py-1",class:t.disabled?"bg-light border":"main-bg-color",on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.clickEvent.apply(void 0,arguments)}}},[i("v-uni-text",{staticClass:"font",class:t.disabled?"text-light-muted":"text-white"},[t._v(t._s(t.name))])],1)},o=[]},"1f04":function(t,e,i){"use strict";i.r(e);var n=i("cba2"),a=i("65db");for(var o in a)"default"!==o&&function(t){i.d(e,t,(function(){return a[t]}))}(o);var s,c=i("f0c5"),r=Object(c["a"])(a["default"],n["b"],n["c"],!1,null,"258bb1a8",null,!1,n["a"],s);e["default"]=r.exports},"2fb9":function(t,e,i){"use strict";(function(t){var n=i("4ea4");i("99af"),i("c740"),i("4160"),i("a434"),i("2ca0"),i("159b"),Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var a=n(i("5530")),o=i("26cb"),s=(n(i("a2a0")),n(i("9a93"))),c={data:function(){return{scrollIntoView:"",mode:"text",actionList:[[{name:"相册",icon:"/static/images/extends/pic.png",event:"uploadImage"},{name:"拍摄",icon:"/static/images/extends/video.png",event:"uploadVideo"},{name:"收藏",icon:"/static/images/extends/shoucan.png",event:"openFava"},{name:"名片",icon:"/static/images/extends/man.png",event:"sendCard"},{name:"位置",icon:"/static/images/extends/path.png",event:""}]],emoticonList:[],KeyboardHeight:0,menusList:[],navBarHeight:0,list:[],propIndex:-1,text:"",isRecording:!1,RecordingStartY:0,unRecord:!1,detail:{id:0,name:"",avatar:"",chat_type:"user"}}},mounted:function(){var t=this,e=0;this.navBarHeight=e+uni.upx2px(90),uni.onKeyboardHeightChange((function(e){"action"!==t.mode&&"emoticon"!==t.mode&&(t.KeyboardHeight=e.height),t.KeyboardHeight>0&&t.pageToBottom()})),this.pageToBottom()},computed:(0,a.default)((0,a.default)({},(0,o.mapState)({chatList:function(t){return t.user.chatList},RECORD:function(t){return t.audio.RECORD},RecordTime:function(t){return t.audio.RecordTime},chat:function(t){return t.user.chat},totalNoreadnum:function(t){return t.user.totalNoreadnum},user:function(t){return t.user.user}})),{},{currentChatItem:function(){var t=this,e=this.chatList.findIndex((function(e){return e.id===t.detail.id&&e.chat_type===t.detail.chat_type}));return-1!==e?this.chatList[e]:{}},maskBottom:function(){return this.KeyboardHeight+uni.upx2px(105)},getMenusHeight:function(){var t=100;return this.menusList.length*t},getMenusStyle:function(){return"height: ".concat(this.getMenusHeight,"rpx;")},isdoSelf:function(){var t=1,e=this.propIndex>-1?this.list[this.propIndex].user_id:0;return e===t},chatBodyBottom:function(){return"bottom:".concat(uni.upx2px(105)+this.KeyboardHeight,"px;top:").concat(this.navBarHeight,"px;")},emoticonOrActionList:function(){return"emoticon"===this.mode||"action"===this.mode?this[this.mode+"List"]:[]},imageList:function(){var t=[];return this.list.forEach((function(e){"emoticon"!==e.type&&"image"!==e.type||t.push(e.data)})),t}}),watch:{mode:function(t,e){"action"!==t&&"emoticon"!==t&&this.$refs.action.hide(),"text"!==t&&uni.hideKeyboard()}},onLoad:function(e){if(!e.params)return this.backToast();this.detail=JSON.parse(decodeURIComponent(e.params)),t.log(this.detail),this.__init(),this.chat.createChatObject(this.detail),this.list=this.chat.getChatDetail(),uni.$on("onMessage",this.onMessage),uni.$on("updateHistory",this.updateHistory),uni.$on("sendItem",this.onSendItem)},destroyed:function(){this.chat.destoryChatObject(),uni.$off("onMessage",this.onMessage),uni.$off("updateHistory",this.updateHistory),uni.$off("sendItem",this.onSendItem)},methods:(0,a.default)((0,a.default)({},(0,o.mapMutations)(["regSendVoiceEvent"])),{},{onSendItem:function(t){"fava"!==t.sendType&&"card"!==t.sendType||this.send(t.type,t.data,t.options)},updateHistory:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.list=t?[]:this.chat.getChatDetail()},onMessage:function(e){var i=this;if(t.log("[聊天页] 监听接收聊天信息",e),e.from_id===this.detail.id&&"user"===e.chat_type||"group"===e.chat_type&&e.to_id===this.detail.id){if(1!==e.isremove)return this.list.push(e),this.pageToBottom();t.log("撤回消息:",e);var n=this.list.findIndex((function(t){return t.id===e.data}));t.log("撤回消息 index:",n),-1!==n&&setTimeout((function(){i.list=i.chat.getChatDetail()}),10)}},__init:function(){for(var t=20,e=Math.ceil(t/8),i=[],n=0;n<e;n++){var a=8*n;i[n]=[];for(var o=0;o<8;o++){var c=a+o;c+1>t||i[n].push({name:"表情"+c,icon:s.default.emoticonUrl+c+".gif",event:"sendEmoticon"})}}this.emoticonList=i;var r={chat_type:this.detail.chat_type,to_id:this.detail.id,to_name:this.detail.name,to_avatar:this.detail.avatar,data:"user"===this.detail.chat_type?"我们已经是好友，可以开始聊天了":"你已经加入群聊，可以开始聊天了"};"group"===this.detail.chat_type&&this.detail.group&&(r.group=this.detail.group),this.chat.initChatListItem(r)},openActionOrEmoticon:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"action";this.mode=t,this.$refs.action.show(),uni.hideKeyboard(),this.KeyboardHeight=uni.upx2px(580)},send:function(e){var i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(e){case"text":n=n||this.text;break}var o=this.chat.formatSendData({type:e,data:n,options:a}),s=this.list.length;this.list.push(o);var c=!1;"image"!==o.type&&"video"!==o.type&&"audio"!==o.type||("string"!==typeof o.data||"string"===typeof o.data&&!o.data.startsWith("http"))&&(!0,c=function(e){t.log("上传进度：",e)}),this.chat.send(o,c).then((function(e){t.log(e),i.list[s].id=e.id,i.list[s].sendStatus="success"})).catch((function(e){i.list[s].sendStatus="fail",t.log(e)})),"text"===e&&(this.text=""),this.pageToBottom()},pageToBottom:function(){},long:function(t){var e=t.x,i=t.y,n=t.index;this.propIndex=n;var a=[{name:"发送给朋友",event:"sendToChatItem"},{name:"收藏",event:"fava"},{name:"删除",event:"delete"}],o=this.list[this.propIndex],s=this.user.id===o.from_id;s&&a.push({name:"撤回",event:"removeChatItem"}),this.menusList=a,this.$refs.extend.show(e,i)},clickEvent:function(t){var e=this,i=this.list[this.propIndex],n=this.user.id===i.from_id;switch(t){case"removeChatItem":this.chat.recall(i).then((function(t){i.isremove=1,uni.$emit("updateHistory",!1)})).catch((function(t){uni.showToast({title:t,icon:"none",duration:2e3})}));break;case"sendToChatItem":uni.navigateTo({url:"../chat-list/chat-list?params="+encodeURIComponent(JSON.stringify(i))});break;case"copy":uni.setClipboardData({data:i.data,success:function(){uni.showToast({title:"复制成功",icon:"none"})}});break;case"delete":uni.showModal({content:"是否要删除该记录？",success:function(t){t.confirm&&(e.chat.deleteChatDetailItem(i,n),e.list.splice(e.propIndex,1),e.list.length===e.propIndex&&e.chat.updateChatItem({id:e.detail.id,chat_type:e.detail.chat_type},(function(t){var i=e.list[e.propIndex-1],a="";return i&&(a=e.chat.formatChatItemData(i,n)),t.data=a,t})))}});break;case"fava":uni.showModal({content:"是否要加入收藏？",success:function(t){t.confirm}});break}this.$refs.extend.hide()},actionEvent:function(e){var i=this;switch(e.event){case"uploadImage":uni.chooseImage({count:9,success:function(t){t.tempFiles.forEach((function(t){i.send("image",t)}))}});break;case"uploadVideo":uni.chooseVideo({maxDuration:10,success:function(e){t.log("uploadVideo:",e),e.tempFile.tempFilePath=e.tempFilePath,i.send("video",e.tempFile)}});break;case"sendEmoticon":this.send("emoticon",e.icon);break;case"openFava":uni.navigateTo({url:"../../my/fava/fava?type=send"});break;case"sendCard":uni.navigateTo({url:"../../mail/mail/mail?type=sendCard&limit=1"});break;case"userCall":uni.navigateTo({url:"../user-call/user-call??info="+JSON.stringify({uid:"user-id-"+this.user.id})});break}},clickPage:function(){this.mode=""},previewImage:function(t){uni.previewImage({current:t,urls:this.imageList,indicator:"default"})},changeVoiceOrText:function(){this.mode="audio"!==this.mode?"audio":"text"},voiceTouchStart:function(t){this.isRecording=!0,this.RecordingStartY=t.changedTouches[0].screenY,this.unRecord=!1,this.RECORD.start({format:"mp3"})},voiceTouchEnd:function(){this.isRecording=!1,this.RECORD.stop()},voiceTouchCancel:function(){this.isRecording=!1,this.unRecord=!0,this.RECORD.stop()},voiceTouchMove:function(t){var e=Math.abs(t.changedTouches[0].screenY-this.RecordingStartY);this.unRecord=e>=50},openChatSet:function(){uni.navigateTo({url:"../chat-set/chat-set?params="+JSON.stringify({id:this.detail.id,chat_type:this.detail.chat_type})})}})};e.default=c}).call(this,i("5a52")["default"])},"40db":function(t,e,i){"use strict";i.r(e);var n=i("1524"),a=i("9857");for(var o in a)"default"!==o&&function(t){i.d(e,t,(function(){return a[t]}))}(o);var s,c=i("f0c5"),r=Object(c["a"])(a["default"],n["b"],n["c"],!1,null,"40510ab7",null,!1,n["a"],s);e["default"]=r.exports},"65db":function(t,e,i){"use strict";i.r(e);var n=i("2fb9"),a=i.n(n);for(var o in n)"default"!==o&&function(t){i.d(e,t,(function(){return n[t]}))}(o);e["default"]=a.a},9857:function(t,e,i){"use strict";i.r(e);var n=i("9a79"),a=i.n(n);for(var o in n)"default"!==o&&function(t){i.d(e,t,(function(){return n[t]}))}(o);e["default"]=a.a},"9a79":function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n={props:{name:{type:String,default:""},disabled:{type:Boolean,default:!1}},methods:{clickEvent:function(){this.disabled||this.$emit("click")}}};e.default=n},cba2:function(t,e,i){"use strict";i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return o})),i.d(e,"a",(function(){return n}));var n={freeNavBar:i("3e12").default,freeIconButton:i("b060").default,freeChatItem:i("5220").default,freeMainButton:i("40db").default,freePopup:i("b042").default},a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-uni-view",[i("free-nav-bar",{attrs:{title:t.detail.name,noreadnum:t.totalNoreadnum,showBack:!0}},[i("free-icon-button",{attrs:{slot:"right",icon:"",name:"more-fill"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.openChatSet.apply(void 0,arguments)}},slot:"right"})],1),i("v-uni-scroll-view",{staticClass:"bg-light position-fixed left-0 right-0 px-3",staticStyle:{bottom:"105rpx","box-sizing":"border-box"},style:t.chatBodyBottom,attrs:{"scroll-y":!0,"show-scrollbar":!1,"scroll-into-view":t.scrollIntoView,"scroll-with-animation":!0},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.clickPage.apply(void 0,arguments)}}},t._l(t.list,(function(e,n){return i("v-uni-view",{key:n,attrs:{id:"chatItem_"+n}},[i("free-chat-item",{ref:"chatItem",refInFor:!0,attrs:{item:e,index:n,pretime:n>0?t.list[n-1].create_time:0,shownickname:t.currentChatItem.shownickname},on:{long:function(e){arguments[0]=e=t.$handleEvent(e),t.long.apply(void 0,arguments)},preview:function(e){arguments[0]=e=t.$handleEvent(e),t.previewImage()}}})],1)})),1),i("v-uni-view",{staticClass:"position-fixed left-0 right-0 border-top flex align-center",staticStyle:{"background-color":"#F7F7F6",height:"105rpx"},style:"bottom:"+t.KeyboardHeight+"px;"},["audio"===t.mode?[i("free-icon-button",{attrs:{icon:"",name:"imkeyboard"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.changeVoiceOrText.apply(void 0,arguments)}}})]:[i("free-icon-button",{attrs:{icon:"",name:"news"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.changeVoiceOrText.apply(void 0,arguments)}}})],i("v-uni-view",{staticClass:"flex-1"},["audio"===t.mode?i("v-uni-view",{staticClass:"rounded flex align-center justify-center",class:t.isRecording?"bg-hover-light":"bg-white",staticStyle:{height:"80rpx"},on:{touchstart:function(e){arguments[0]=e=t.$handleEvent(e),t.voiceTouchStart.apply(void 0,arguments)},touchend:function(e){arguments[0]=e=t.$handleEvent(e),t.voiceTouchEnd.apply(void 0,arguments)},touchcancel:function(e){arguments[0]=e=t.$handleEvent(e),t.voiceTouchCancel.apply(void 0,arguments)},touchmove:function(e){arguments[0]=e=t.$handleEvent(e),t.voiceTouchMove.apply(void 0,arguments)}}},[i("v-uni-text",{staticClass:"font"},[t._v(t._s(t.isRecording?"松开 结束":"按住 说话"))])],1):i("v-uni-textarea",{staticClass:"bg-white rounded p-2 font-md",staticStyle:{height:"50rpx","max-width":"450rpx"},attrs:{fixed:!0,"adjust-position":!1},on:{focus:function(e){arguments[0]=e=t.$handleEvent(e),t.mode="text"}},model:{value:t.text,callback:function(e){t.text=e},expression:"text"}})],1),i("free-icon-button",{attrs:{icon:"",name:"satisfied"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.openActionOrEmoticon("emoticon")}}}),0===t.text.length?[i("free-icon-button",{attrs:{icon:"",name:"immore"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.openActionOrEmoticon("action")}}})]:i("v-uni-view",{staticClass:"flex-shrink"},[i("free-main-button",{attrs:{name:"发送"},on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.send("text")}}})],1)],2),i("free-popup",{ref:"action",attrs:{bottom:!0,transformOrigin:"center bottom",mask:!1},on:{hide:function(e){arguments[0]=e=t.$handleEvent(e),t.KeyboardHeight=0}}},[i("v-uni-view",{staticClass:"border-top border-light-secondary bg-light",staticStyle:{height:"580rpx"}},[i("v-uni-swiper",{staticStyle:{height:"510rpx"},attrs:{"indicator-dots":t.emoticonOrActionList.length>1}},t._l(t.emoticonOrActionList,(function(e,n){return i("v-uni-swiper-item",{key:n,staticClass:"row"},t._l(e,(function(e,n){return i("v-uni-view",{key:n,staticClass:"col-3 flex flex-column align-center justify-center",staticStyle:{height:"255rpx"},on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.actionEvent(e)}}},[i("v-uni-image",{staticStyle:{width:"100rpx",height:"100rpx"},attrs:{src:e.icon,mode:"widthFix"}}),i("v-uni-text",{staticClass:"font-sm text-muted mt-2"},[t._v(t._s(e.name))])],1)})),1)})),1)],1)],1),i("free-popup",{ref:"extend",attrs:{bodyWidth:240,bodyHeight:450,tabbarHeight:105}},[i("v-uni-view",{staticClass:"flex flex-column",staticStyle:{width:"240rpx"},style:t.getMenusStyle},t._l(t.menusList,(function(e,n){return i("v-uni-view",{key:n,staticClass:"flex-1 flex align-center",attrs:{"hover-class":"bg-light"},on:{click:function(i){arguments[0]=i=t.$handleEvent(i),t.clickEvent(e.event)}}},[i("v-uni-text",{staticClass:"font-md pl-3"},[t._v(t._s(e.name))])],1)})),1)],1),t.isRecording?i("v-uni-view",{staticClass:"position-fixed top-0 left-0 right-0 flex align-center justify-center",staticStyle:{bottom:"105rpx"}},[i("v-uni-view",{staticClass:"rounded flex flex-column align-center justify-center",staticStyle:{width:"360rpx",height:"360rpx","background-color":"rgba(0,0,0,0.5)"}},[i("v-uni-image",{staticStyle:{width:"150rpx",height:"150rpx"},attrs:{src:"/static/audio/recording.gif"}}),i("v-uni-text",{staticClass:"font text-white mt-3"},[t._v(t._s(t.unRecord?"松开手指，取消发送":"手指上滑，取消发送"))])],1)],1):t._e()],1)},o=[]}}]);